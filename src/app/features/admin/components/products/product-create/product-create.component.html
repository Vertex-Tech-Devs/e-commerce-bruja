<div class="container-fluid my-4">
  <div class="card-gradient-wrapper">
    <div class="card form-card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center gap-3 mb-4">
          <h2 class="page-title mb-0">{{ pageTitle }}</h2>
          <button class="btn btn-outline-secondary btn-sm" (click)="onCancel()">
            <i class="bi bi-arrow-left"></i>
            {{ isEditMode ? "Volver al Detalle" : "Volver a la Lista" }}
          </button>
        </div>

        <form [formGroup]="productForm" (ngSubmit)="onSubmit()" novalidate>
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="name" class="form-label">Nombre del Producto</label>
              <input
                type="text"
                id="name"
                class="form-control"
                formControlName="name"
                [ngClass]="{
                  'is-invalid': name?.invalid && (name?.dirty || name?.touched)
                }"
              />
              <div
                *ngIf="name?.invalid && (name?.dirty || name?.touched)"
                class="invalid-feedback"
              >
                <div *ngIf="name?.errors?.['required']">
                  El nombre es obligatorio.
                </div>
                <div *ngIf="name?.errors?.['minlength']">
                  Debe tener al menos 3 caracteres.
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <label for="category" class="form-label">Categoría</label>
              <select
                id="category"
                class="form-select"
                formControlName="category"
                [ngClass]="{
                  'is-invalid':
                    category?.invalid && (category?.dirty || category?.touched)
                }"
              >
                <option [ngValue]="null" disabled>
                  Selecciona una categoría
                </option>
                <ng-container *ngIf="categories$ | async as categories">
                  <option *ngFor="let cat of categories" [value]="cat.name">
                    {{ cat.name }}
                  </option>
                </ng-container>
              </select>
              <div
                *ngIf="
                  category?.invalid && (category?.dirty || category?.touched)
                "
                class="invalid-feedback"
              >
                <div *ngIf="category?.errors?.['required']">
                  La categoría es obligatoria.
                </div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="description" class="form-label">Descripción</label>
            <textarea
              id="description"
              class="form-control"
              formControlName="description"
              rows="4"
              [ngClass]="{
                'is-invalid':
                  description?.invalid &&
                  (description?.dirty || description?.touched)
              }"
            ></textarea>
            <div
              *ngIf="
                description?.invalid &&
                (description?.dirty || description?.touched)
              "
              class="invalid-feedback"
            >
              <div *ngIf="description?.errors?.['required']">
                La descripción es obligatoria.
              </div>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="price" class="form-label">Precio</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input
                  type="number"
                  id="price"
                  class="form-control"
                  formControlName="price"
                  [ngClass]="{
                    'is-invalid':
                      price?.invalid && (price?.dirty || price?.touched)
                  }"
                />
              </div>
              <div
                *ngIf="price?.invalid && (price?.dirty || price?.touched)"
                class="invalid-feedback"
              >
                <div *ngIf="price?.errors?.['required']">
                  El precio es obligatorio.
                </div>
                <div *ngIf="price?.errors?.['min']">
                  El precio no puede ser negativo.
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <label for="stock" class="form-label">Stock Disponible</label>
              <input
                type="number"
                id="stock"
                class="form-control"
                formControlName="stock"
                [ngClass]="{
                  'is-invalid':
                    stock?.invalid && (stock?.dirty || stock?.touched)
                }"
              />
              <div
                *ngIf="stock?.invalid && (stock?.dirty || stock?.touched)"
                class="invalid-feedback"
              >
                <div *ngIf="stock?.errors?.['required']">
                  El stock es obligatorio.
                </div>
                <div *ngIf="stock?.errors?.['min']">
                  El stock no puede ser negativo.
                </div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Talles Disponibles</label>
            <div class="d-flex flex-wrap gap-3" formArrayName="sizes">
              <div class="form-check" *ngFor="let size of availableSizes; let i = index">
                <input class="form-check-input" type="checkbox" [id]="'size-' + i" [formControlName]="i">
                <label class="form-check-label" [for]="'size-' + i">
                  {{ size }}
                </label>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="image" class="form-label">URL de la Imagen</label>
            <input
              type="url"
              id="image"
              class="form-control"
              formControlName="image"
              [ngClass]="{
                'is-invalid':
                  image?.invalid && (image?.dirty || image?.touched)
              }"
            />
            <div
              *ngIf="image?.invalid && (image?.dirty || image?.touched)"
              class="invalid-feedback"
            >
              <div *ngIf="image?.errors?.['required']">
                La URL de la imagen es obligatoria.
              </div>
              <div *ngIf="image?.errors?.['pattern']">
                Por favor, introduce una URL válida.
              </div>
            </div>
          </div>

          <div
            *ngIf="image?.valid && image?.value"
            class="mt-3 mb-4 text-center image-preview-wrapper"
          >
            <img
              [src]="image?.value"
              alt="Vista previa de la imagen"
              class="img-fluid rounded shadow-sm image-preview"
            />
          </div>

          <hr class="my-4" />

          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" (click)="onCancel()">
              Cancelar
            </button>
            <button
              type="submit"
              class="btn btn-primary"
              [disabled]="productForm.invalid || isSubmitting"
            >
              <span
                *ngIf="isSubmitting"
                class="spinner-border spinner-border-sm me-2"
                role="status"
                aria-hidden="true"
              ></span>
              {{
                isSubmitting
                  ? "Guardando..."
                  : isEditMode
                  ? "Actualizar Producto"
                  : "Crear Producto"
              }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
